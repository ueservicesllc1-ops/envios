rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Reglas para productos
    match /products/{productId} {
      // Permitir lectura pública para la tienda
      allow read: if true;
      // Solo escritura para usuarios autenticados
      allow write: if request.auth != null;
    }
    
    // Reglas para inventario
    match /inventory/{inventoryId} {
      // Permitir lectura pública para mostrar stock
      allow read: if true;
      // Solo escritura para usuarios autenticados
      allow write: if request.auth != null;
    }
    
    // Reglas para notas de entrada
    match /entryNotes/{noteId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para notas de salida
    match /exitNotes/{noteId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para contabilidad
    match /accounting/{entryId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para vendedores
    match /sellers/{sellerId} {
      // Permitir lectura pública para la tienda pública
      allow read: if true;
      // Solo escritura para usuarios autenticados
      allow write: if request.auth != null;
    }
    
    // Reglas para tienda de vendedores (sellerStore)
    match /sellerStore/{storeProductId} {
      // Permitir lectura pública solo de productos activos para la tienda pública
      allow read: if true;
      // Solo escritura para usuarios autenticados
      allow write: if request.auth != null;
    }
    
    // Reglas para inventario de vendedores (sellerInventory)
    match /sellerInventory/{inventoryId} {
      // Permitir lectura pública para verificar stock en la tienda pública
      allow read: if true;
      // Solo escritura para usuarios autenticados
      allow write: if request.auth != null;
    }
    
    // Reglas para proveedores
    match /suppliers/{supplierId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para clientes
    match /customers/{customerId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para configuración
    match /settings/{settingId} {
      // Permitir lectura pública para storeSettings y perfumeSettings
      allow read: if true;
      // Solo escritura para usuarios autenticados
      allow write: if request.auth != null;
    }
    
    // Reglas para productos vendidos
    match /soldProducts/{soldProductId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para notas de pago
    match /paymentNotes/{paymentNoteId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para ventas de notas de salida
    match /exitNoteSales/{saleId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para ventas eliminadas
    match /deletedSales/{deletedSaleId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para envíos (shipping)
    match /shipping/{shippingId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para gastos de envío (shippingExpenses)
    match /shippingExpenses/{expenseId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para gastos de notas de entrada (entryNoteExpenses)
    match /entryNoteExpenses/{expenseId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para órdenes (orders)
    match /orders/{orderId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para devoluciones (returns)
    match /returns/{returnId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para ventas en línea (onlineSales)
    match /onlineSales/{saleId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para contabilidad de ventas en línea (onlineSaleAccounting)
    match /onlineSaleAccounting/{entryId} {
      allow read, write: if request.auth != null;
    }
    
    // Reglas para perfumes (productos de pedido, no integrados al inventario)
    match /perfumes/{perfumeId} {
      // Permitir lectura pública (la aplicación filtrará los activos)
      // Esto permite consultas con where sin problemas de permisos
      allow read: if true;
      // Solo escritura para usuarios autenticados
      allow write: if request.auth != null;
    }
    
    // Reglas para configuración de perfumes (perfumeSettings)
    match /perfumeSettings/{settingId} {
      // Permitir lectura pública
      allow read: if true;
      // Solo escritura para usuarios autenticados
      allow write: if request.auth != null;
    }
    
    // Reglas para preferencias de usuario (userPreferences)
    match /userPreferences/{userId} {
      // Permitir que cada usuario lea y escriba sus propias preferencias
      // Y permitir al admin leer/escribir todas
      allow read, write: if request.auth != null && (request.auth.uid == userId || request.auth.token.email == 'ueservicesllc1@gmail.com');
    }
    
    // Reglas para POS Sales
    match /pos_sales/{saleId} {
      allow read, write: if request.auth != null;
    }

    // Reglas para POS Accounting
    match /pos_accounting/{entryId} {
      allow read, write: if request.auth != null;
    }

    // Reglas para POS Customers
    match /pos_customers/{customerId} {
      allow read, write: if request.auth != null;
    }

    // Reglas para conversaciones de chat
    match /conversations/{conversationId} {
      // Permitir lectura y escritura a usuarios autenticados
      allow read, write: if request.auth != null;
    }

    // Reglas para mensajes de chat
    match /chatMessages/{messageId} {
      // Permitir lectura y escritura a usuarios autenticados
      allow read, write: if request.auth != null;
    }

    // Reglas para cupones
    match /coupons/{couponId} {
      // Los usuarios pueden leer sus propios cupones
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      // Los usuarios autenticados pueden crear cupones (para el juego de recompensas)
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // Solo admins pueden actualizar cupones (marcar como usados)
      allow update: if request.auth != null;
    }

    // Reglas para mensajes de contacto
    match /contact_messages/{messageId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null;
    }

    // Regla por defecto - denegar todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
